name: build-and-push # 单仓库镜像构建与推送

on:
  # push 到 main 自动构建；workflow_dispatch 便于手动重试或快速回滚
  push:
    branches: [ main ]
  workflow_dispatch: {}

env:
  # 镜像注册中心 / 项目名称依赖 Secrets，避免硬编码
  IMAGE_REGISTRY: ${{ secrets.HARBOR_REGISTRY }}
  IMAGE_PROJECT:  ${{ secrets.HARBOR_PROJECT }}
  IMAGE_NAME: app-demo # 建议与仓库名保持一致便于检索

jobs:
  docker:
    runs-on: [self-hosted, linux, x64, harbor-local] # 自托管 runner，具备 Harbor 内网访问
    permissions:
      contents: read   # 最小权限：仅读取仓库内容
      packages: write  # 允许写入 GHCR/缓存，满足 buildx GHA 缓存需求
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 保留完整 Git 历史，方便生成标签或追溯

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Run unit tests
        working-directory: app-demo
        env:
          DATABASE_URL: sqlite:///./test_app.db
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
          pytest

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3 # 默认 docker-container driver，支持多平台与外部缓存

      - name: Login to Harbor
        uses: docker/login-action@v3
        with:
          registry: ${{ env.IMAGE_REGISTRY }} # Harbor 域名
          username: ${{ secrets.HARBOR_USERNAME }}
          password: ${{ secrets.HARBOR_PASSWORD }}

      - name: Build and push image (with cache)
        uses: docker/build-push-action@v6
        with:
          context: ./app-demo # 使用应用目录作为构建上下文
          file: ./app-demo/Dockerfile
          push: true # 构建完成后推送到远端注册中心
          tags: |
            ${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_PROJECT }}/${{ env.IMAGE_NAME }}:latest
            ${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_PROJECT }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          cache-from: type=gha # 读取 GitHub Cache v2，加速冷启动
          cache-to: type=gha,mode=max # 导出全部层到 Cache v2，便于后续命中
          labels: |
            org.opencontainers.image.source=${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
          sbom: true # 生成 SBOM 供漏洞扫描/合规审计
          provenance: true # 生成 SLSA provenance，支持供应链验证
